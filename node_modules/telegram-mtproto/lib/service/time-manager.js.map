{"version":3,"sources":["../../src/service/time-manager.js"],"names":["log","tsNow","seconds","t","Date","window","tsOffset","Math","floor","generateMessageID","uid","timeTicks","timeSec","timerOffset","get","timeMSec","random","messageID","lastMessageID","set","applyServerTime","serverTime","localTime","newTimeOffset","changed","abs","generateID"],"mappings":";;;;;;;AAEA;;;;AAEA;;AACA;;;;AAEA;;;;;;AAEA,IAAMA,MAAM,uBAAO,cAAnB;;AAEO,IAAMC,wBAASC,OAAD,IAA+B;AAClD,MAAIC,IAAI,CAAC,IAAIC,IAAJ,EAAT;AACA;AACA,MAAI,qBAAJ,EAAaD,KAAKE,OAAOC,QAAP,IAAmB,CAAxB;AACb,SAAOJ,UACHK,KAAKC,KAAL,CAAWL,IAAI,IAAf,CADG,GAEHA,CAFJ;AAGD,CAPM;;AAUP,IAAMM,oBAAqBC,GAAD,IAAiB;AACzC,MAAMC,YAAYV,OAAlB;AAAA,MACMW,UAAUL,KAAKC,KAAL,CAAWG,YAAY,IAAvB,IAA+B,yBAAOE,WAAP,CAAmBC,GAAnB,CAAuBJ,GAAvB,CAD/C;AAAA,MAEMK,WAAWJ,YAAY,IAF7B;AAAA,MAGMK,SAAS,wBAAc,MAAd,CAHf;;AAKA,MAAIC,YAAY,CAACL,OAAD,EAAUG,YAAY,EAAZ,GAAiBC,UAAU,CAA3B,GAA+B,CAAzC,CAAhB;AACA,MAAME,gBAAgB,yBAAOA,aAAP,CAAqBJ,GAArB,CAAyBJ,GAAzB,CAAtB;AACA,MAAIQ,cAAc,CAAd,IAAmBD,UAAU,CAAV,CAAnB,IACFC,cAAc,CAAd,KAAoBD,UAAU,CAAV,CAApB,IAAoCC,cAAc,CAAd,KAAoBD,UAAU,CAAV,CAD1D,EACwE;AACtEA,gBAAY,CAACC,cAAc,CAAd,CAAD,EAAmBA,cAAc,CAAd,IAAmB,CAAtC,CAAZ;AACD;AACD,2BAAOA,aAAP,CAAqBC,GAArB,CAAyBT,GAAzB,EAA8BO,SAA9B;;AAEA;;AAEA,SAAO,mBAASA,UAAU,CAAV,CAAT,EAAuBA,UAAU,CAAV,CAAvB,CAAP;AACD,CAjBD;;AAmBO,IAAMG,4CAAkB,CAC7BV,GAD6B,EAE7BW,UAF6B,EAG7BC,SAH6B,KAGN;;AAEvB,MAAMC,gBAAgBF,aAAad,KAAKC,KAAL,CAAW,CAACc,aAAarB,OAAd,IAAyB,IAApC,CAAnC;AACA,MAAMuB,UAAUjB,KAAKkB,GAAL,CAAS,yBAAOZ,WAAP,CAAmBC,GAAnB,CAAuBJ,GAAvB,IAA8Ba,aAAvC,IAAwD,EAAxE;;AAEA,2BAAOL,aAAP,CAAqBC,GAArB,CAAyBT,GAAzB,EAA8B,CAAC,CAAD,EAAI,CAAJ,CAA9B;AACA,2BAAOG,WAAP,CAAmBM,GAAnB,CAAuBT,GAAvB,EAA4Ba,aAA5B;AACAvB,MAAI,mBAAJ,EAAyBqB,UAAzB,EAAqCC,SAArC,EAAgDC,aAAhD,EAA+DC,OAA/D;;AAEA,SAAOA,OAAP;AACD,CAbM;;QAeuBE,U,GAArBjB,iB","file":"time-manager.js","sourcesContent":["//@flow\n\nimport isNode from 'detect-node'\n\nimport { nextRandomInt, lshift32 } from '../bin'\nimport Config from '../config-provider'\n\nimport Logger from 'mtproto-logger'\n\nconst log = Logger`time-manager`\n\nexport const tsNow = (seconds?: boolean): number => {\n  let t = +new Date()\n  //eslint-disable-next-line\n  if (!isNode) t += window.tsOffset || 0\n  return seconds\n    ? Math.floor(t / 1000)\n    : t\n}\n\n\nconst generateMessageID = (uid: string) => {\n  const timeTicks = tsNow(),\n        timeSec = Math.floor(timeTicks / 1000) + Config.timerOffset.get(uid),\n        timeMSec = timeTicks % 1000,\n        random = nextRandomInt(0xFFFF)\n\n  let messageID = [timeSec, timeMSec << 21 | random << 3 | 4]\n  const lastMessageID = Config.lastMessageID.get(uid)\n  if (lastMessageID[0] > messageID[0] ||\n    lastMessageID[0] == messageID[0] && lastMessageID[1] >= messageID[1]) {\n    messageID = [lastMessageID[0], lastMessageID[1] + 4]\n  }\n  Config.lastMessageID.set(uid, messageID)\n\n  // console.log('generated msg id', messageID, timerOffset)\n\n  return lshift32(messageID[0], messageID[1])\n}\n\nexport const applyServerTime = (\n  uid: string,\n  serverTime: number,\n  localTime?: number) => {\n\n  const newTimeOffset = serverTime - Math.floor((localTime || tsNow()) / 1000)\n  const changed = Math.abs(Config.timerOffset.get(uid) - newTimeOffset) > 10\n\n  Config.lastMessageID.set(uid, [0, 0])\n  Config.timerOffset.set(uid, newTimeOffset)\n  log('Apply server time')(serverTime, localTime, newTimeOffset, changed)\n\n  return changed\n}\n\nexport { generateMessageID as generateID }\n"]}